# Use the specific vulnerable version of Apache
FROM httpd:2.4.49

# 1. Create the Flag File
ARG FLAG_CONTENT
RUN echo "FLAG{Ap4ch3_P4th_Trav3rs4l_CVE_2021_41773}" > /flag.txt
# Ensure the flag is world-readable so the apache user can access it
RUN chmod 644 /flag.txt

# 2. Configure Apache to be Vulnerable
# Enable cgid_module for RCE potential
RUN sed -i 's/^#LoadModule cgid_module/LoadModule cgid_module/' conf/httpd.conf

# 3. CRITICAL FIX: Robust Permissions Override
# Instead of relying on sed replacement which can miss due to whitespace,
# we append a new, authoritative Directory block for the root filesystem
# to the end of the config file. Apache respects the last directive.
RUN echo >> conf/httpd.conf && \
    echo "<Directory />" >> conf/httpd.conf && \
    echo "    AllowOverride none" >> conf/httpd.conf && \
    echo "    Require all granted" >> conf/httpd.conf && \
    echo "</Directory>" >> conf/httpd.conf

# 4. Create a dummy CGI script
RUN mkdir -p /usr/local/apache2/cgi-bin/
RUN echo "#!/bin/sh" > /usr/local/apache2/cgi-bin/test.sh
RUN echo "echo Content-type: text/plain" >> /usr/local/apache2/cgi-bin/test.sh
RUN echo "echo" >> /usr/local/apache2/cgi-bin/test.sh
RUN echo "echo 'CGI is working'" >> /usr/local/apache2/cgi-bin/test.sh
RUN chmod +x /usr/local/apache2/cgi-bin/test.sh

EXPOSE 80